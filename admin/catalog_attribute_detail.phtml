<%
	Response.CodePage = 65001
	Response.CharSet = "UTF-8"
	
	storeviewid = Trim(Request("storeviewid"))
	if Len(storeviewid) > 0 then
		Session("CURRENT_ADMIN_VIEW_ID")  = storeviewid
	end if
%>
<!-- #INCLUDE File="local/local.phtml" -->
<!-- #INCLUDE File="util/xt_func_util.phtml" -->
<!-- #INCLUDE File="util/xt_func_string.phtml" -->
<!-- #INCLUDE File="include/i_login.phtml" -->
<%
	attribute_id = Trim(Request("id"))
	
	sql = "SELECT * FROM " & g_storeid & "_eav_attribute WHERE attribute_id=" & attribute_id
	set rs = dbconn.Execute(sql)
	if not rs.EOF then
		admin_label = rs("admin_label")
		frontend_label = rs("frontend_label")
		configurable = rs("configurable")
	end if
	rs.Close
	set rs = nothing
	
	if Session("CURRENT_ADMIN_VIEW_ID") <> "1" then
		frontend_label = TranslateX(frontend_label, 20, attribute_id, 1)
	end if
		
	'===============================================================================================
	'Options
	'===============================================================================================
	s_data = ""
	
	sql = "SELECT a.option_id, b.value, a.sort_order FROM " & g_storeid & "_eav_attribute_option as a, "
	sql = sql & g_storeid & "_eav_attribute_option_value as b "
	sql = sql & "WHERE a.option_id = b.option_id AND "
	sql = sql & "b.view_id = " & Session("CURRENT_ADMIN_VIEW_ID") & " AND "
	sql = sql & "a.attribute_id =" & attribute_id
	
	if Session("CURRENT_ADMIN_VIEW_ID") = "1" then
		sql = "SELECT option_id, option_name, sort_order, display_name FROM " & g_storeid & "_eav_attribute_option WHERE attribute_id =" & attribute_id & " ORDER BY sort_order, option_name"
	else
		'sql = "SELECT option_id, (CASE WHEN b.field_value IS NULL THEN a.option_name ELSE b.field_value END) as oname, a.sort_order FROM " & g_storeid & "_eav_attribute_option as a "
		'sql = sql & "LEFT OUTER JOIN " & g_storeid & "_store_type_data_varchar as b "
		'sql = sql & "ON CONVERT(varchar(10), a.option_id) = b.entity_id "
		'sql = sql & "WHERE attribute_id = 1 "
		'sql = sql & "AND (type_id is null OR type_id=21) "
		'sql = sql & "AND (view_id is null or view_id=" & Session("CURRENT_ADMIN_VIEW_ID") & ") "
		'sql = sql & "ORDER BY sort_order, oname "
		
		sql = "SELECT option_id, (CASE WHEN b.field_value IS NULL THEN a.option_name ELSE b.field_value END) as oname, a.sort_order  "
		sql = sql & "FROM " & g_storeid & "_eav_attribute_option as a "
		sql = sql & "LEFT OUTER JOIN (SELECT * FROM " & g_storeid & "_store_type_data_varchar WHERE type_id=21 and view_id=" & Session("CURRENT_ADMIN_VIEW_ID") & ") as b "
		sql = sql & "ON CONVERT(varchar(10), a.option_id) = b.entity_id "
		sql = sql & "WHERE attribute_id = " & attribute_id & " "
		sql = sql & "ORDER BY sort_order, oname "
	end if
	
	set rsOptions = dbconn.Execute(sql)
	attr_id = 1
	do while not rsOptions.EOF
		s_value = Trim(rsOptions(1))
		s_display_name = Trim(rsOptions(3))
		
		if Len(s_value) > 0 then
			s_value = Replace(Trim(rsOptions(1)), """", "\""")
		end if
		if Len(s_display_name) > 0 then
			s_display_name = Replace(Trim(rsOptions(3)), """", "\""")
		end if
		'TODO : translate...
		'if Session("CURRENT_ADMIN_VIEW_ID") <> "1" then
			's_value = TranslateX(s_value, 21, rsOptions(0), 1)
		'end if
		's_data = s_data & "{ ""ID"": " & attr_id & ",  ""OptionID"": " & rsOptions(0) & ", ""Name"": """ & s_value & """, ""Position"": """ & Trim(rsOptions(2)) & """ },"
		
		s_data = s_data & "{ ""ID"": " & attr_id & ",  ""OptionID"": " & rsOptions(0) & ", ""Name"": """ & s_value & """, ""Position"": """ & Trim(rsOptions(2)) & """,  ""DisplayName"": """ & s_display_name & """ },"
		attr_id = attr_id + 1
		rsOptions.MoveNext
	loop
	rsOptions.Close
	set rsOptions = nothing
	
	if Len(s_data) > 0 then
		s_data = Left(s_data, Len(s_data) - 1)
	end if
	s_data = "[" & s_data & "]"
	s_data_option = s_data
		
	
%>
<!--#INCLUDE FILE="include/doctype.phtml"-->
<head>
<!--#INCLUDE FILE="include/head.phtml"-->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link rel="stylesheet" href="assets/plugins/jquery-ui/jquery-ui-1.10.4.custom.min.css" />
<link rel="stylesheet" type="text/css" href="assets/plugins/grid/grid-0.5.6.min.css" />
<!-- END PAGE LEVEL PLUGINS -->
<!--#INCLUDE FILE="include/head_bottom.phtml"-->
</head>

<body class="page-container-bg-solid">
<div class="page-wrapper">
	<div class="page-wrapper-row">
		<div class="page-wrapper-top">
			<!--#INCLUDE FILE="include/header.phtml"-->
		</div>
	</div>
	<div class="page-wrapper-row full-height">
		<div class="page-wrapper-middle">
			<!-- BEGIN CONTAINER -->
			<div class="page-container">
				<!-- BEGIN CONTENT -->
				<div class="page-content-wrapper">
					<!-- BEGIN CONTENT BODY -->
					<!-- BEGIN PAGE HEAD-->
					
					<!-- END PAGE HEAD-->
					<!-- BEGIN PAGE CONTENT BODY -->
					<div class="page-content">
						<div class="container-fluid">
							<!-- BEGIN PAGE CONTENT INNER -->
							<div class="page-content-inner">
								<div class="row">
									<div class="col-md-12">
										<form id="form_edit_1" class="form-horizontal form-row-seperated" action="#">
										<input type="hidden" id="attribute_id" name="attribute_id" value="<%=attribute_id%>">
											<div class="portlet">
												<div class="portlet-title">
													<div class="caption">
													<%
													if Len(frontend_label) > 0 then
														Response.Write(frontend_label)
													else
														Response.Write("New Filter")
													end if
													%>
													</div>
													<div class="actions btn-set">
														<button type="button" onclick="location.href='catalog_attribute.phtml';" name="back" class="btn btn-default">
															<i class="fa fa-angle-left"></i> Back
														</button>
														<button class="btn btn-success" onclick="savebutton='1';">
															<i class="fa fa-check"></i> Save
														</button>
														<button class="btn btn-success" onclick="savebutton='0';">
															<i class="fa fa-check-circle"></i> Save & Continue Edit
														</button>
														<div class="btn-group">
															<a class="btn btn-success dropdown-toggle" href="javascript:;" data-toggle="dropdown">
																<i class="fa fa-share"></i> More
																<i class="fa fa-angle-down"></i>
															</a>
															<div class="dropdown-menu pull-right">
																<!--
																<li>
																	<a href="javascript:;" id="DuplicateEntry"> Duplicate </a>
																</li>
																-->
																<li>
																	<a href="#" id="DeleteEntry"> Delete </a>
																</li>
															</div>
														</div>
													</div>
												</div>
												<div class="alert alert-danger display-hide">
												<button class="close" data-close="alert"></button> You have some form errors. Please check below. 
												</div>
												<div class="alert alert-success display-hide">
												<button class="close" data-close="alert"></button> The information has been saved.
												</div>
												<div class="alert alert-warning display-hide">
												<button class="close" data-close="alert"></button> The information has not been saved properly. Please contact system administrator.
												</div>
												<div class="portlet-body">
													<div class="tabbable-bordered">
														<ul id="myTab3" class="nav nav-tabs">
															<li class="active">
																<a href="#panel_tab4_example1" data-toggle="tab">
																	<i class="pink fa fa-info"></i> Information
																</a>
															</li>
															<% if attribute_id <> "0" then %>
															<li class="">
																<a href="#panel_tab4_example2" data-toggle="tab">
																	<i class="blue fa fa-info-circle"></i> Manage Options
																</a>
															</li>
															<% end if %>
														</ul>
														
														<div class="tab-content">
															<div class="tab-pane active" id="panel_tab4_example1">
																<div class="row">
																	<div class="col-sm-6">
																		<div class="form-group">
																			<label class="col-sm-4 control-label" for="admin_label">
																				Name <span class="symbol required"></span> 
																			</label>
																			<div class="col-sm-8">
																				<input type="text" placeholder="" id="admin_label" name="admin_label" class="form-control input-sm" value="<%=admin_label%>">
																			</div>
																		</div>
																		<div class="form-group">
																			<label class="col-sm-4 control-label" for="frontend_label">
																				Display Name <span class="symbol required"></span> 
																			</label>
																			<div class="col-sm-8">
																				<input type="text" placeholder="" id="frontend_label" name="frontend_label" class="form-control input-sm" value="<%=frontend_label%>">
																			</div>
																		</div>
																		<div class="form-group">
																			<label class="col-sm-4 control-label" for="configurable">
																				Use for Configurable <span class="symbol required"></span> 
																			</label>
																			<div class="col-sm-8">
																				<select class="form-control input-sm" name="configurable" id="configurable">
																					<option value="0" <%if configurable=0 then%>selected<%end if%>>No</option>
																					<option value="1" <%if configurable=1 then%>selected<%end if%>>Yes</option>
																				</select>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
															<div class="tab-pane" id="panel_tab4_example2">
																<div class="row">
																	<div class="col-md-8">
																		<% if Session("CURRENT_ADMIN_VIEW_ID") = "1" then %>
																		<a class="btn green btn-xs" role="button" id="btnAdd0">
																		<i class="fa fa-plus"></i> Add New 
																		</a>
																		<br><br>
																		<% end if %>
																		<table id="grid0"></table>
																		<div id="dialog-option" style="display:none">
																			<input type="hidden" id="ID">
																			<input type="hidden" id="OptionID">
																			<table border="0">
																				<tbody>
																				<tr>
																					<td style="padding:5px;"><label for="OptionName">Name:</label></td>
																					<td style="padding:5px;"><input type="text" id="OptionName" style="width:300px;font-size:14px;"></td>
																				</tr>
																				<tr>
																					<td style="padding:5px;"><label for="DisplayName">Display:</label></td>
																					<td style="padding:5px;"><input type="text" id="DisplayName" style="width:300px;font-size:14px;"></td>
																				</tr>
																				<tr>
																					<td style="padding:5px;"><label for="OptionPosition">Postition:</label></td>
																					<td style="padding:5px;"><input type="text" id="OptionPosition" style="width:300px;font-size:14px;"></td>
																				</tr>
																				</tbody>
																			</table>
																		</div>
																	</div>
																	<input type="hidden" name="attribute_option_data" id="attribute_option_data" value="">
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</form>
									</div>
								</div>
							</div>
							<!-- END PAGE CONTENT INNER -->
						</div>
					</div>
					<!-- END PAGE CONTENT BODY -->
					<!-- END CONTENT BODY -->
				</div>
				<!-- END CONTENT -->
			</div>
			<!-- END CONTAINER -->
		</div>
	</div>
	<div class="page-wrapper-row">
		<div class="page-wrapper-bottom">
			<!--#INCLUDE FILE="include/footer.phtml"-->
		</div>
	</div>
</div>
<!--#INCLUDE FILE="include/js.phtml"-->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script src="../assets/global/plugins/jquery-validation/js/jquery.validate.min.js" type="text/javascript"></script>
<script src="../assets/global/plugins/jquery-validation/js/additional-methods.min.js" type="text/javascript"></script>
<script src="assets/plugins/jquery-ui/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>
<script src="assets/plugins/grid/grid-0.5.6.min.js" type="text/javascript"></script>
<!-- END PAGE LEVEL PLUGINS -->

<!-- BEGIN PAGE LEVEL SCRIPTS -->
<script>
var data0, grid0, dialog0;
</script>
<script language="javascript">
var savebutton = "1";
var FormValidation = function () {
	// basic validation
	var handleValidation1 = function() {
		var form1 = $('#form_edit_1');
		var error1 = $('.alert-danger', form1);
		var success1 = $('.alert-success', form1);
		var warning1 = $('.alert-warning', form1);

		form1.validate({
			errorElement: 'span', //default input error message container
			errorClass: 'help-block help-block-error', // default input error message class
			focusInvalid: false, // do not focus the last invalid input
			ignore: "",  // validate all fields including form hidden input
			//RULES
			rules: {
				
				pf_name: {
					minlength: 2,
					required: true
				}
				
			},

			invalidHandler: function (event, validator) { //display error alert on form submit              
				success1.hide();
				warning1.hide();
				error1.show();
				App.scrollTo(error1, -200);
			},

			errorPlacement: function (error, element) { // render error placement for each input type
				var cont = $(element).parent('.input-group');
				if (cont) {
					cont.after(error);
				} else {
					element.after(error);
				}
			},

			highlight: function (element) { // hightlight error inputs

				$(element)
					.closest('.form-group').addClass('has-error'); // set error class to the control group
			},

			unhighlight: function (element) { // revert the change done by hightlight
				$(element)
					.closest('.form-group').removeClass('has-error'); // set error class to the control group
			},

			success: function (label) {
				label
					.closest('.form-group').removeClass('has-error'); // set success class to the control group
			},

			submitHandler: function (form) {
				success1.hide();
				error1.hide
				warning1.hide();
				
				window.scrollTo(0,0);
					
				records = grid0.getAll();
				pid = "";
				$.each(records, function () {
					 pid += this.record.OptionID + "||" + this.record.Name + "||" + this.record.Position + "||" + this.record.DisplayName + "%%";
				});
				$('#attribute_option_data').val(pid);
				
				$.ajax({
					type: "POST",
					url: "api/sp_catalog_attribute_update.phtml",
					data: form1.serialize(),
					success: function() {
						success1.show();
						if (savebutton == "1")
						{
						setTimeout(function () {
								window.location.replace("catalog_attribute.phtml");
							}, 500);
						}
					},
					error: function() {
						warning1.show();
					}
				});
			}
		});


	}
	return {
		//main function to initiate the module
		init: function () {
			handleValidation1();
		}
	};

}();
</script>
<script>
jQuery(document).ready(function() {
	FormValidation.init();
	//GRIDS
	data0 = <%=s_data_option%>;
	dialog0 = $("#dialog-option").dialog({
		title: "Add/Edit Options",
		autoOpen: false,
		resizable: false,
		width: '400px',
		modal: true,
		buttons: {
			"Save": Save0,
			"Cancel": function () { $(this).dialog("close"); }
		}
	});
	
	function Edit0(e) {
		$("#ID").val(e.data.id);
		$("#OptionID").val(e.data.record.OptionID);
		$("#OptionName").val(e.data.record.Name);
		$("#DisplayName").val(e.data.record.DisplayName);
		$("#OptionPosition").val(e.data.record.Position);
		$("#dialog-option").dialog("open");
	}
	function Delete0(e) {
		if (confirm("Are you sure?")) {
			grid0.removeRow(e.data.id);
		}
	}
	function Save0() {
		if ($.isNumeric($("#OptionPosition").val()))
		{
			sPostion = $("#OptionPosition").val();
		}
		else
		{
			sPostion = "0";
		}
		
		if ($("#ID").val()) {
			var id = parseInt($("#ID").val());
			grid0.updateRow(id, { "ID": id, "OptionID": $("#OptionID").val(), "Name": $("#OptionName").val(), "Position": sPostion, "DisplayName": $("#DisplayName").val() });
		} else {
			grid0.addRow({ "ID": grid0.count() + 1, "OptionID": $("#OptionID").val(), "Name": $("#OptionName").val(), "Position": sPostion, "DisplayName": $("#DisplayName").val() });
		}
		$(this).dialog("close");
	}
	 
	 
	function Delete0(e) {
		if (confirm("Are you sure?")) {
			grid0.removeRow(e.data.id);
		}
	}
	
	grid0 = $("#grid0").grid({
		dataSource: data0,
		uiLibrary: "bootstrap",
		columns: [
			{ field: "Name", title: "Option Name" },
			{ field: "DisplayName", title: "Display Name" },
			{ field: "Position", title: "Position", width: 80 },
			{ title: "", width: 40, type: "icon", icon: "glyphicon-pencil", tooltip: "Edit", events: { "click": Edit0 } },
			{ title: "", width: 40, type: "icon", icon: "glyphicon-remove", tooltip: "Delete", events: { "click": Delete0 } }
		]
	});
	
	$("#btnAdd0").on("click", function () {
		$("#ID").val("");
		$("#OptionID").val("0");
		$("#OptionName").val("");
		$("#DisplayName").val("");
		$("#OptionPosition").val("0");
		$("#dialog-option").dialog("open");
	});
});
</script>
<!-- END PAGE LEVEL SCRIPTS -->
</body>
</html>